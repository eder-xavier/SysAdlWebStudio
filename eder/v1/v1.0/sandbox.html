<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>SysADL Sandbox</title>
</head>
<body>
<script>
window.parent && window.parent.postMessage({ type: 'sandbox-ready' }, '*');
</script>

<script>
(function(){
  function respond(msg) {
    try { window.parent && window.parent.postMessage(msg, '*'); } catch(e) {}
  }

  function evalTransformer(sourceText){
    try {
      sourceText = sourceText
        .replace(/async\s+function\s+main\s*\(\s*input\s*\)/g, 'async function main(/*input_removed_for_browser*/)')
        .replace(/function\s+main\s*\(\s*input\s*\)/g, 'function main(/*input_removed_for_browser*/)');
    } catch(e) { /* ignore */ }

    var wrapper =
      '(function(){\n' +
      '  var module = { exports: {} };\n' +
      '  var exports = module.exports;\n' +
      '  var process = { env: {} };\n' +
      '  var fs = { existsSync: function(){return false;}, mkdirSync: function(){}, writeFileSync: function(){} };\n' +
      "  var path = { sep: '/', resolve: function(){return Array.from(arguments).join('/');}, join: function(){return Array.from(arguments).join('/').replace(/\\/+/, '/');}, basename: function(p){ var a=p.split(/\\\\|\//); return a[a.length-1]||p; }, extname: function(p){ var m=p.match(/\.[^/.]+$/); return m?m[0]:''; }, dirname: function(p){ return p.split(/\\\\|\//).slice(0,-1).join('/'); }, normalize: function(p){ return p.replace(/\\/+/, '/'); }, isAbsolute: function(p){ return /^([a-zA-Z]:\\\\|\/)/.test(p); } };\n" +
      "  var require = function(name){ if(name==='path') return path; if(name==='fs') return fs; if(name==='process') return process; throw new Error('require não suportado no sandbox: '+name); };\n" +
      sourceText + '\n' +
      "  if (typeof Transformer !== 'undefined') return Transformer;\n" +
      '  return module.exports;\n' +
      '})()';

    var T;
    try {
      T = (0,eval)(wrapper);
    } catch (e) {
      throw new Error('Erro ao avaliar transformer: ' + (e && e.message ? e.message : String(e)));
    }
    if (!T) throw new Error('Transformer não expôs API esperada.');
    try { window.Transformer = T; } catch(e){}
    return T;
  }

  window.addEventListener('message', async function(ev){
    var data = ev && ev.data;
    if (!data || data.type !== 'transform') return;

    try {
      if (!window.Transformer) {
        if (!data.transformer || typeof data.transformer !== 'string') {
          throw new Error('Transformer ausente no sandbox.');
        }
        evalTransformer(data.transformer);
      }
      var T = window.Transformer;
      if (!T || (!T.generateClassModule && !T.main)) {
        throw new Error('Transformer indisponível no sandbox.');
      }

      var ast = data.ast;
      if (!ast && data.source && T.parse) ast = T.parse(data.source);
      if (!ast) throw new Error('AST não recebido do parent.');

      var confs = (T.extractConfigurations && T.extractConfigurations(ast)) || [];
      var conf = confs[0] || {};
      var compUses = (T.collectComponentUses && T.collectComponentUses(conf)) || [];
      var portUses = (T.collectPortUses && T.collectPortUses(conf)) || [];

      var connectorBindings = [], executables = [], activitiesToRegister = [], rootDefs = [];
      var parentMap = {}, compInstanceDef = {}, compDefMap = {}, portDefMap = {};
      var embeddedTypes = {}, connectorDefMap = {}, packageMap = {};

      var js;
      if (T.generateClassModule) {
        js = T.generateClassModule(
          'ModelFromUI',
          compUses,
          portUses,
          connectorBindings,
          executables,
          activitiesToRegister,
          rootDefs,
          parentMap,
          compInstanceDef,
          compDefMap,
          portDefMap,
          embeddedTypes,
          connectorDefMap,
          packageMap,
          ast,
          data.source || ''
        );
      } else if (T.main) {
        js = T.main(ast);
      } else {
        throw new Error('Nenhuma API de geração reconhecida.');
      }

      respond({ type: 'transformResult', ok: true, code: String(js||'') });
    } catch (err) {
      var msg = err && err.message ? err.message : String(err);
      var loc = err && err.location ? err.location : null;
      respond({ type: 'transformResult', ok: false, error: msg, location: loc });
    }
  });
})();
</script>
</body>
</html>
