<!DOCTYPE html>
<html>
<head>
    <title>Debug - C√≥digo Gerado</title>
</head>
<body>
    <h1>Debug: Verificar C√≥digo Gerado</h1>
    <button id="test">Testar AGV-completo.sysadl</button>
    <div id="output" style="white-space: pre-wrap; font-family: monospace; font-size: 12px; margin: 20px 0; max-height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;"></div>
    <h3>Primeiras linhas do c√≥digo gerado:</h3>
    <div id="codePreview" style="white-space: pre-wrap; font-family: monospace; font-size: 11px; background: #f5f5f5; padding: 10px; border: 1px solid #ccc;"></div>

    <script src="./sysadl-framework/SysADLBase.js?v=20250925-1731"></script>
    <script src="./transformer.js?v=20250925-1731"></script>
    <script type="module">
        import { parse as sysadlParse } from './sysadl-parser.js';
        
        const output = document.getElementById('output');
        const codePreview = document.getElementById('codePreview');
        const testBtn = document.getElementById('test');
        
        function log(msg) {
            output.textContent += msg + '\n';
            console.log(msg);
        }
        
        testBtn.addEventListener('click', async () => {
            output.textContent = '';
            codePreview.textContent = '';
            log('=== Debug: Testando Gera√ß√£o de C√≥digo ===');
            
            try {
                // Caregar arquivo
                const response = await fetch('./AGV-completo.sysadl');
                const sysadlCode = await response.text();
                log('‚úÖ AGV-completo.sysadl carregado');
                
                // Parse
                const ast = sysadlParse(sysadlCode);
                log('‚úÖ Parse realizado');
                
                // Verificar se Transformer existe e tem a vers√£o corrigida
                if (!window.Transformer) {
                    log('‚ùå window.Transformer n√£o dispon√≠vel');
                    return;
                }
                
                log('‚úÖ window.Transformer dispon√≠vel');
                log('Fun√ß√µes dispon√≠veis: ' + Object.keys(window.Transformer).join(', '));
                
                // Usar a mesma l√≥gica do app.js
                const T = window.Transformer;
                
                // Parse e prepara√ß√£o (igual ao app.js)
                const conf = (T.extractConfigurations(ast) || [])[0] || {};
                const compUses = T.collectComponentUses ? T.collectComponentUses(conf) : [];
                const portUses = T.collectPortUses ? T.collectPortUses(conf) : [];
                
                // Par√¢metros placeholder (igual ao app.js)
                const connectorBindings = [];
                const executables = [];
                const activitiesToRegister = [];
                const rootDefs = [];
                const parentMap = {};
                const compInstanceDef = {};
                const compDefMap = {};
                const portDefMap = {};
                const embeddedTypes = {};
                const connectorDefMap = {};
                const packageMap = {};
                
                log('‚úÖ Prepara√ß√£o dos par√¢metros conclu√≠da');
                
                // Gera√ß√£o do c√≥digo JavaScript
                const js = T.generateClassModule(
                    'ModelFromUI',
                    compUses,
                    portUses,
                    connectorBindings,
                    executables,
                    activitiesToRegister,
                    rootDefs,
                    parentMap,
                    compInstanceDef,
                    compDefMap,
                    portDefMap,
                    embeddedTypes,
                    connectorDefMap,
                    packageMap
                );
                
                log('‚úÖ C√≥digo JavaScript gerado com sucesso');
                log('Tamanho: ' + js.length + ' caracteres');
                
                // Mostrar primeiras linhas para verificar se a corre√ß√£o est√° aplicada
                const firstLines = js.split('\\n').slice(0, 15).join('\\n');
                codePreview.textContent = firstLines;
                
                // Verificar se a corre√ß√£o est√° aplicada
                if (js.includes('String: SysADLString')) {
                    log('‚úÖ CORRE√á√ÉO APLICADA: Encontrado "String: SysADLString"');
                } else {
                    log('‚ùå CORRE√á√ÉO N√ÉO APLICADA: N√£o encontrado "String: SysADLString"');
                }
                
                if (js.includes('const String = SysADLString;')) {
                    log('‚úÖ RE-EXPORT APLICADO: Encontrado "const String = SysADLString;"');
                } else {
                    log('‚ùå RE-EXPORT N√ÉO APLICADO: N√£o encontrado "const String = SysADLString;"');
                }
                
                // Testar execu√ß√£o
                log('üîÑ Testando execu√ß√£o...');
                const cjsCode = `
var module = { exports: {} };
var exports = module.exports;
function require(p){
  if (p && String(p).includes('SysADLBase')) return window.SysADLBase;
  throw new Error('require n√£o suportado no browser: '+p);
}

${js}

;module.exports`;
                
                const result = eval(cjsCode);
                log('‚úÖ Execu√ß√£o bem-sucedida!');
                
                if (typeof result.createEnvironmentModel === 'function') {
                    log('‚úÖ createEnvironmentModel encontrada');
                    const model = result.createEnvironmentModel();
                    log('‚úÖ Modelo criado: ' + (model.name || 'sem nome'));
                } else {
                    log('‚ö†Ô∏è createEnvironmentModel n√£o encontrada');
                }
                
            } catch (error) {
                log('‚ùå ERRO: ' + error.message);
                log('Stack: ' + error.stack?.substring(0, 300));
            }
        });
    </script>
</body>
</html>